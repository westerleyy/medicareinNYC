---
title: "EDA Medicare Part B"
author: "Wesley Chioh"
date: "April 2, 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# reading in packages

library(tidyverse)
library(ggplot2)
library(DT)
library(caret)
library(randomForest)
library(plotly)

# data paths 
path <- "./data/"
medicare_folder <- "medicare_part_b/"

# reading in data
medicare_part_b_2017 <- read_csv(paste(path, medicare_folder, "MEDICARE_PROVIDER_CHARGE_INPATIENT_DRGALL_FY2017.CSV", sep = ""))
nyc_zip_codes <- c(10453, 10457, 10460, 10458, 10467, 10468, 10451, 10452, 10456, 10454, 10455, 10459, 10474, 10463, 10471, 10466, 10469, 10470, 10475, 10461, 10462,10464, 10465, 10472, 10473, 	11212, 11213, 11216, 11233, 11238, 	11209, 11214, 11228, 	11204, 11218, 11219, 11230, 11234, 11236, 11239, 11223, 11224, 11229, 11235, 	11201, 11205, 11215, 11217, 11231, 11203, 11210, 11225, 11226, 	11207, 11208, 	11211, 11222,	11220, 11232,	11206, 11221, 11237,	10026, 10027, 10030, 10037, 10039,	10001, 10011, 10018, 10019, 10020, 10036,	10029, 10035,	10010, 10016, 10017, 10022,	10012, 10013, 10014,	10004, 10005, 10006, 10007, 10038, 10280,	10002, 10003, 10009,	10021, 10028, 10044, 10065, 10075, 10128,	10023, 10024, 10025,10031, 10032, 10033, 10034, 10040,	11361, 11362, 11363, 11364,11354, 11355, 11356, 11357, 11358, 11359, 11360,11365, 11366, 11367,	11412, 11423, 11432, 11433, 11434, 11435, 11436, 	11101, 11102, 11103, 11104, 11105, 11106,	11374, 11375, 11379, 11385,11691, 11692, 11693, 11694, 11695, 11697,	11004, 11005, 11411, 11413, 11422, 11426, 11427, 11428, 11429,	11414, 11415, 11416, 11417, 11418, 11419, 11420, 11421,	11368, 11369, 11370, 11372, 11373, 11377, 11378,10302, 10303, 10310,	10306, 10307, 10308, 10309, 10312,10301, 10304, 10305,10314)
nyc_health_plus <- c("JACOBI MEDICAL CENTER", "LINCOLN MEDICAL & MENTAL HEALTH CENTER", "NORTH CENTRAL BRONX HOSPITAL", "CONEY ISLAND HOSPITAL", "KINGS COUNTY HOSPITAL CENTER", "WOODHULL MEDICAL AND MENTAL HEALTH CENTER", "BELLEVUE HOSPITAL CENTER", "HARLEM HOSPITAL CENTER", "METROPOLITAN HOSPITAL CENTER", "ELMHURST HOSPITAL CENTER", "QUEENS HOSPITAL CENTER")
```


```{r New York}
nyc_medicare_2017 <- medicare_part_b_2017 %>%
  filter(`Provider Zip Code` %in% nyc_zip_codes) %>%
  mutate(zip_3 = substr(`Provider Zip Code`, 1, 3),
         borough = ifelse(zip_3 == 104, "Bronx", ifelse(zip_3 == 112, "Brooklyn", 
                                                        ifelse(zip_3 == 100, "Manhattan", 
                                                               ifelse(zip_3 == 103, "Staten Island", "Queens")))),
         health_plus = ifelse(`Provider Name` %in% nyc_health_plus, "Y", "N"))
nyc_hospitals <- nyc_medicare_2017$`Provider Name` %>%
  unique
nyc_hospitals_borough <- nyc_medicare_2017 %>%
  group_by(borough) %>%
  summarise(number_hospitals = n_distinct(`Provider Name`))
datatable(nyc_hospitals_borough)
```

Okay so if we look at this `nyc_hospitals_borough`, we clearly see that there is a geographical imbalance in terms of the number of hospitals per borough. Queens is probably the most underserved borough in this regard since it is also the biggest borough by land area, right?  
  
We also have another problem. How do you determine if a procedure is the most common? Do you sum up the number of procedures in a given year, and then rank? Or do you find the most common procedure at each hospital?  

```{r common procedures}
procedures_count <- nyc_medicare_2017 %>%
  group_by(`DRG Definition`) %>%
  summarise(discharge_count = sum(`Total Discharges`)) %>%
  arrange(desc(discharge_count))
head(procedures_count, n = 10)
```

So, if we look at the 10 most common procedures by the total number of discharges, septicemia/sepsis treatments are leading the pack.  

```{r cost differences}
nyc_medicare_2017_ten_common <- nyc_medicare_2017 %>%
  filter(`DRG Definition` %in% unlist(procedures_count$`DRG Definition`)[1:10]) %>%
  select(`Provider Name`, `DRG Definition`, `Total Discharges`, `Average Total Payments`, borough, health_plus) %>%
  mutate(DRG_num = as.character(substr(`DRG Definition`, 1, 3)))
cost_boxplot <- ggplot(nyc_medicare_2017_ten_common, aes(DRG_num, `Average Total Payments`)) + 
  geom_boxplot() + 
  labs(title = "Box Plot of Average Total Payments by DRG",
       subtitle = "Each observation is the averal total payments attributed to each hospital",
       x = "DRG Number",
       y = "Average Total Payments")
cost_boxplot
```

Okay, so there is a huge variance between hospitals for each of the ten most common procedures. Are there hospitals that are consistently above or below average? 

```{r hospital averages, fig.width=14}
nyc_medicare_2017_ten_common_zscores <- nyc_medicare_2017_ten_common %>%
  group_by(DRG_num) %>%
  mutate(mean_total_payment = mean(`Average Total Payments`),
         sd_total_payment = sd(`Average Total Payments`)) %>%
  ungroup() %>%
  mutate(z_score = (`Average Total Payments`-mean_total_payment)/sd_total_payment)
hospital_scatter <- ggplot(nyc_medicare_2017_ten_common_zscores, aes(`Provider Name`, z_score, label = DRG_num)) + 
  geom_point(aes(col = health_plus)) + 
  geom_hline(yintercept = 0) +
  coord_flip() + 
  labs(title = "Z-score Scatterplot",
       subtitle = "No. of std dev for each common DRG by hospital",
       y = "Standard Deviations",
       x = "Hospital")
ggplotly(hospital_scatter)
```
  
Scandal! All NYC Health-Plus, ie public hospitals, charge more than private ones, with the exception of Coney Island Hospital.  